<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گرفتن عکس و افزایش کیفیت</title>
    <style>
        video {
            max-width: 100%;
            border: 2px solid #ccc;
        }
        canvas {
            display: none;
        }
        img {
            max-width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>گرفتن عکس و افزایش کیفیت با TensorFlow.js</h1>
    <video id="cameraStream" autoplay playsinline></video>
    <br><br>
    <button onclick="takePhoto()">گرفتن عکس</button>
    <button onclick="enhanceAndDownload()">افزایش کیفیت و دانلود</button>
    <canvas id="hiddenCanvas"></canvas>
    <img id="photoPreview" alt="عکس گرفته شده">

    <!-- لود کتابخانه TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.15.0/dist/tf.min.js"></script>
    <script>
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('hiddenCanvas');
        const photoPreview = document.getElementById('photoPreview');

        // دسترسی به دوربین
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                console.error("خطا در دسترسی به دوربین:", error);
            });

        // گرفتن عکس
        function takePhoto() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // نقاشی تصویر دوربین روی canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // نمایش عکس گرفته شده
            photoPreview.src = canvas.toDataURL('image/png');
        }

        // افزایش کیفیت تصویر با TensorFlow.js
        async function enhanceAndDownload() {
            if (!photoPreview.src) {
                alert("ابتدا یک عکس بگیرید!");
                return;
            }

            // لود مدل Super Resolution (SR)
            const modelUrl = 'https://tfhub.dev/google/lite-model/aiy/vision/quality enhancement/sr3dfp/1?lite-format=tflite';
            const model = await tf.loadGraphModel(modelUrl);

            // تبدیل عکس به Tensor
            const tensor = tf.browser.fromPixels(canvas).resizeNearestNeighbor([canvas.height * 3, canvas.width * 3]);

            // اجرای مدل بر روی تصویر
            const enhancedTensor = model.execute(tensor);

            // تبدیل خروجی مدل به Canvas
            const enhancedCanvas = document.createElement('canvas');
            enhancedCanvas.width = enhancedTensor.shape[1];
            enhancedCanvas.height = enhancedTensor.shape[2];
            const ctx = enhancedCanvas.getContext('2d');
            const imageData = new ImageData(await enhancedTensor.data(), enhancedTensor.shape[1], enhancedTensor.shape[2]);
            ctx.putImageData(imageData, 0, 0);

            // نمایش تصویر پردازش‌شده
            photoPreview.src = enhancedCanvas.toDataURL('image/png');

            // دانلود تصویر پردازش‌شده
            const link = document.createElement('a');
            link.href = photoPreview.src;
            link.download = 'enhanced_photo.png';
            link.click();

            // حذف تنسورها از حافظه
            tensor.dispose();
            enhancedTensor.dispose();
        }
    </script>
</body>
</html>
